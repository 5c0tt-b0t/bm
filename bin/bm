#!/usr/bin/env bash

# version

VERSION="0.1.0"

# bookmarks dir

DIR=~/Dropbox

# bookmarks file

BOOKMARKS=$DIR/bookmarks

#
# Output usage info
#

usage() {
  cat <<EOF

  Usage: bm [options] [cmd]

  Commands:

    # add a bookmark with the given url, description, and optional tags
    $ bm add <url> [desc] [tag...]

    # open the first bookmark matching <query>
    $ bm open <query>
    $ bm <query>

    # search the bookmarks via full-text <query>
    $ bm search <query>

    # list bookmarks available
    $ bm list
    $ bm ls
    $ bm

    # view bookmark screenshots in your default browser
    $ vm view

    # clear all bookmarks
    $ bm clear

  Options:

     -V, --version   output bm version
     -h, --help      output this help information

EOF
}

#
# Add a bookmark
#
#   <url> [description] [tag ...] 
#

save_bookmark() {
  local url=$1
  local desc=$2
  local tags=${@:3}
  echo
  echo "  Added bookmark"
  echo
  echo "    url: $url"
  echo "    description: $desc"
  echo "    tags: $tags"
  echo
  echo "$url|$desc|$tags" >> $BOOKMARKS
}

#
# List all bookmarks
#

list_bookmarks() {
  echo
  cat $BOOKMARKS \
    | awk '
    BEGIN { FS = "|" }
    { printf "  \033[36m%28s\033[0m  %-30s \033[90m(%s)\033[0m\n", $1, $2, $3 }' \
    | sed 's/http:\/\///'
  echo
}

#
# Search all bookmarks with <query>
#

search_bookmarks() {
  echo
  list_bookmarks | grep $1
  echo
}

#
# Open first bookmark matching <query>
#

open_bookmark() {
  cat $BOOKMARKS \
    | grep $1 \
    | cut -d '|' -f 1 \
    | xargs open
}

#
# Stylesheet
#

style() {
  cat <<EOF
<style>
  body {
    padding: 50px 0 5px 50px;
    font: 12px Helvetica;
  }
  .bm {
    float: left;
    margin: 5px;
    padding: 5px;
    border: 1px solid #eee;
    border-bottom: 1px solid #ddd;
    -webkit-border-radius: 5px;
    -webkit-box-shadow: 0 0 5px #eee;
  }
  p {
    margin: 5px;
  }
  a {
    color: #16acee;
  }
</style>
EOF
}

#
# View bookmark screenshots.
#

view_bookmark_screenshots() {
  style > /tmp/bm.html

  cat $BOOKMARKS \
    | awk 'BEGIN { FS = "|" }
    {
      printf "<div class=bm>\n"
      printf "  <a href=\"%s\">\n", $1
      printf "    <img width=200 height=150 src=\"https://api.url2png.com/v3/P4DE5D1C99D8EF/7bbb6e0d1b74fb0ae1d4f18b06320096/%sx%s/%s\" />\n", 200, 200, $1
      printf "  </a>\n"
      printf "  <p class=link><a href=\"%s\">%s</a></p>\n", $1, $1
      printf "  <p class=desc>%s</p>\n", $2
      printf "</div>\n"
    }' \
    >> /tmp/bm.html \
    && open /tmp/bm.html
}

#
# Remove all bookmarks
#

clear_bookmarks() {
  rm $BOOKMARKS
}

# no args

if test $# -eq 0; then
  list_bookmarks
  exit
fi

# parse args

while test $# -ne 0; do
  arg=$1; shift
  case $arg in
    -V|--version) echo $VERSION; exit ;;
    -h|--help) usage; exit ;;
    ls|list) list_bookmarks; exit ;;
    search) search_bookmarks "$@"; exit ;;
    open) open_bookmark "$@"; exit ;;
    add) save_bookmark "$@"; exit ;;
    view) view_bookmark_screenshots; exit ;;
    clear) clear_bookmarks; exit ;;
    *) open_bookmark $arg; exit ;;
  esac
done
